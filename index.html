<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PYnode</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#11151b; --panel2:#0f1319; --fg:#e9eef7; --muted:#93a0b3;
      --acc:#71f7c3; --acc2:#7aa7ff; --warn:#ff6b6b; --line:#243041;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% 10%, #121a22 0%, var(--bg) 55%);
      color:var(--fg); font-family:var(--sans); overflow:auto;}
    .wrap{display:grid; grid-template-columns: clamp(260px, 28vw, 360px) 1fr; height:100vh;}
    .side{background:linear-gradient(180deg, var(--panel) 0%, #0c0f14 100%); border-right:1px solid var(--line);
      padding:14px 12px; overflow:auto;}
    .main{display:grid; grid-template-rows: 1fr minmax(160px, 38vh); min-height:0;}
    .canvasWrap{position:relative; background:linear-gradient(180deg, #090b0f, #07080b);}
    canvas{width:100%; height:100%; display:block;}
    #timeline{height:86px;}
    .hud{position:absolute; inset:10px 10px auto auto; padding:10px 12px;
      background:rgba(15,19,25,.72); border:1px solid rgba(36,48,65,.8); border-radius:14px;
      font-family:var(--mono); font-size:12px; color:var(--muted); backdrop-filter: blur(6px);}
    .bottom{border-top:1px solid var(--line); background:linear-gradient(180deg, var(--panel2), #090b10);
      padding:10px 12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; overflow:auto; min-height:0;}
    .card{border:1px solid rgba(36,48,65,.9); border-radius:14px; background:rgba(15,19,25,.72);
      padding:10px; overflow:auto; min-height:0;}
    h1{font-size:15px; margin:0 0 10px 0;}
    h2{font-size:12px; margin:0 0 8px 0; color:var(--muted); font-weight:600;}
    .row{display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap;}
    .row label{font-size:12px; color:var(--muted); width:112px;}
    input[type="range"]{width:100%;}
    input[type="number"], button, textarea{
      background:#0b0f14; color:var(--fg); border:1px solid rgba(36,48,65,.9);
      border-radius:10px; padding:8px 10px; font-family:var(--mono); font-size:12px;
    }
    button{cursor:pointer; font-family:var(--sans); font-weight:650; letter-spacing:.2px; border-radius:12px; flex:0 0 auto;}
    button.primary{background:linear-gradient(180deg, rgba(113,247,195,.18), rgba(113,247,195,.06));
      border-color: rgba(113,247,195,.35);}
    button.ghost{background:transparent;}
    button.danger{border-color:rgba(255,107,107,.55); background:linear-gradient(180deg, rgba(255,107,107,.12), rgba(255,107,107,.03));}
    .pill{display:inline-flex; align-items:center; padding:6px 10px; border:1px solid rgba(36,48,65,.9);
      border-radius:999px; background:rgba(10,13,18,.55); font-family:var(--mono); font-size:12px; color:var(--muted);}
    .hr{height:1px; background:rgba(36,48,65,.8); margin:10px 0;}
    .tiny{font-size:11px; color:var(--muted); line-height:1.3;}
    textarea{width:100%; height: clamp(84px, 14vh, 140px); min-height: 84px; resize:vertical; line-height:1.25;}
    .tabs{display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px;}
    .tab{padding:6px 10px; border-radius:999px; border:1px solid rgba(36,48,65,.9); background:rgba(10,13,18,.4);
      font-family:var(--mono); font-size:12px; color:var(--muted); cursor:pointer; user-select:none;}
    .tab.active{border-color:rgba(122,167,255,.55); color:#dbe7ff; background:rgba(122,167,255,.10);}
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap; position:sticky; top:0; background:rgba(15,19,25,.92); padding:6px 0 8px 0; z-index:2;}
    .toolbarSpacer{height:6px;}
    #filePy{display:none;}
    @media (max-width: 1100px){
      .wrap{grid-template-columns: 1fr; grid-template-rows: auto 1fr;}
      .side{border-right:none; border-bottom:1px solid var(--line); max-height: 38vh;}
      .main{grid-template-rows: 1fr minmax(160px, 40vh);}
    }
    @media (max-width: 760px){
      .bottom{grid-template-columns: 1fr;}
      .row label{width:92px;}
      .side{max-height: 42vh;}
      #timeline{height:72px;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="side">
    <h1>PYnode</h1>
    <div class="tiny">Shift+click two nodes to connect. Click an edge to edit latency. Del deletes selected edge. Space play/stop.</div>
    <div class="hr"></div>

    <h2>Transport</h2>
    <div class="row">
      <button id="btnRender" class="primary">Render</button>
      <button id="btnPlay" class="ghost">Play</button>
      <button id="btnStop" class="ghost">Stop</button>
      <span id="pyStatus" class="pill">Pyodide: loading…</span>
    </div>
    <div class="row">
      <label>Duration (s)</label>
      <input id="duration" type="range" min="5" max="180" step="1" value="30"/>
    </div>
    <div class="row">
      <label></label>
      <span class="pill"><span id="durationLbl">30</span>s</span>
      <span class="tiny" id="renderStatus" style="margin-left:8px;"></span>
    </div>
    <div class="row">
      <label>Master</label>
      <input id="master" type="range" min="0" max="1" step="0.001" value="0.75"/>
    </div>

    <div class="hr"></div>

    <h2>Emitters</h2>
    <div class="tiny">Event sources (multi-rate). Modes: fixed / walk / random / burst.</div>
    <div class="tiny" id="emittersLegend">Each emitter: target node + probability + jitter.</div>
    <div id="emitters"></div>
    <div class="row">
      <button id="btnAddEmitter" class="ghost">Add emitter</button>
      <button id="btnRemoveEmitter" class="danger">Remove emitter</button>
      <button id="btnRandomEmitters" class="ghost">Randomise</button>
      <button id="btnResetEmitters" class="ghost">Reset</button>
    </div>

    <div class="hr"></div>

    <h2>Graph</h2>
    <div class="row">
      <button id="btnAddNode" class="ghost">Add node</button>
      <button id="btnRemoveNode" class="danger">Remove node</button>
      <button id="btnGraphPreset" class="ghost">New graph</button>
      <button id="btnClearEdges" class="danger">Clear edges</button>
    </div>
  </div>

  <div class="main">
    <div class="canvasWrap">
      <canvas id="cv"></canvas>
      <div class="hud" id="hud">…</div>
    </div>

    <div class="bottom">
      <div class="card">
        <h2>Node Python synth (.py)</h2>
        <div class="tabs" id="nodeTabs"></div>
        <textarea id="pyCode" spellcheck="false"></textarea>

        <div class="toolbar">
          <button id="btnLoadPy" class="ghost">Load .py…</button>
          <button id="btnExportFile" class="ghost">Export .py</button>
          <input id="filePy" type="file" accept=".py,text/x-python,text/plain"/>
        </div>
        <div class="toolbarSpacer"></div>

        <div class="row">
          <button id="btnApplyPy" class="primary">Apply</button>
          <button id="btnRevertPy" class="ghost">Revert</button>
          <span class="tiny" id="pyMsg"></span>
        </div>
      </div>

      <div class="card">
        <h2>Selected edge latency</h2>
        <div class="row">
          <label>Latency (ms)</label>
          <input id="edgeLatency" type="range" min="0" max="500" step="1" value="120"/>
        </div>
        <div class="row">
          <label>Value</label>
          <input id="edgeLatencyNum" type="number" min="0" max="5000" step="1" value="120"/>
        </div>
        <div class="tiny" id="edgeLabel">No edge selected.</div>

        <div class="row">
          <label>Window (s)</label>
          <input id="tlWindow" type="range" min="2" max="30" step="1" value="10"/>
        </div>
        <div class="row">
          <label></label>
          <span class="pill"><span id="tlWindowLbl">10</span>s</span>
        </div>
        <div class="row">
          <label>Edge glow</label>
          <input id="tlGlow" type="range" min="0" max="1" step="0.001" value="1"/>
        </div>

        <div class="hr"></div>
        <h2>Event timeline</h2>
        <canvas id="timeline" style="width:100%; border-radius:12px; border:1px solid rgba(36,48,65,.9); background:#080a0d;"></canvas>
        <div class="tiny">Scrolls with playhead; events + traversed edges.</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.26.1/full/pyodide.js"></script>
<script src="./app.js"></script>
</body>
</html>
